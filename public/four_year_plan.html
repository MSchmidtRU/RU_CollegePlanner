<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAPS - Four Year Plan</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
        }

        header {
            background-color: #CC0033;
            color: #fff;
            padding: 20px 0;
            text-align: center;
        }

        .header-content {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .header-content img {
            height: 50px;
            /* Adjust height as needed */
            margin-right: 10px;
        }

        nav {
            background-color: #f0f0f0;
            padding: 10px 0;
            text-align: center;
        }

        nav a {
            text-decoration: none;
            color: #CC0033;
            margin: 0 15px;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        nav a:hover {
            color: #fff;
            background-color: #CC0033;
            border-radius: 5px;
        }

        section {
            padding: 50px 20px;
            text-align: center;
        }

        footer {
            background-color: #CC0033;
            color: #fff;
            text-align: center;
            padding: 10px 0;
            position: fixed;
            bottom: 0;
            width: 100%;
        }

        button {
            background-color: #CC0033;
            color: #fff;
            border: none;
            padding: 10px 20px;
            margin-top: 20px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            background-color: #990022;
        }

        .semester-box {
            width: 200px;
            padding: 10px;
            margin: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
            position: relative;
            /* Added for positioning tooltip */
        }

        .semester-title {
            background-color: #CC0033;
            /* Rutgers University red */
            color: white;
            padding: 5px;
            text-align: center;
            border-radius: 5px 5px 0 0;
        }

        .courses-list {
            padding: 10px;
            list-style-type: none;
            /* Remove bullet points */
            margin: 0;
            /* Remove default margin */
        }

        .courses-list li {
            margin-bottom: 5px;
            /* Add some spacing between course names */
        }

        .unused-course {
            color: red;
            /* Highlight unused courses in red */
            cursor: help;
            /* Change cursor to indicate tooltip */
        }

        .fulfilled-course {
            color: green;
            /* Highlight fulfilled courses in green */
            cursor: help;
            /* Change cursor to indicate tooltip */
        }

        .tooltip {
            position: absolute;
            background-color: #333;
            color: white;
            padding: 5px;
            border-radius: 5px;
            z-index: 1;
            visibility: hidden;
        }

        .semester-box:hover .tooltip {
            visibility: visible;
        }

        .alert-icon {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 18px;
            cursor: help;
            /* Change cursor to indicate tooltip */
        }

        .selected-course {
            background-color: #CC0033;
            color: white;
        }

        .courses-list li:hover {
            background-color: lightgray;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0, 0, 0);
            background-color: rgba(0, 0, 0, 0.4);
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }

        .modal-content label {
            display: block;
            margin-bottom: 10px;
        }

        .modal-content input[type="radio"] {
            margin-right: 5px;
        }

        .modal-content input[type="submit"] {
            background-color: #CC0033;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin-top: 10px;
            cursor: pointer;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #CC0033;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <header>
        <h1>MAPS - Four Year Plan</h1>
    </header>

    <nav>
        <a href="index.html">Home</a>
        <a href="course_catalog.html">Course Catalog</a>
        <a href="student_status.html">Student Status</a>
        <a href="four_year_plan.html">4 Year Plan</a>
        <a href="schedule_semester.html">Schedule Semester</a>
        <a href="search_majors_minors.html">Search Majors and Minors</a>
        <a href="request_major_switch.html">Request Major Switch or Declaration</a>
        <a href="academicStatus.html"> View Academic Status</a>
    </nav>

    <div class="spinner" id="spinner"></div>
    <section id="plan-section">
        <div id="myModal" class="modal">
            <div class="modal-content">
                <h2>Select Stable Courses</h2>
                <!-- Radio options for optimization strategy -->
                <label>
                    <input type="radio" id="quickestRadio" name="optimizationStrategy" value="quickest" checked>
                    Quickest
                </label>
                <label>
                    <input type="radio" id="balancedRadio" name="optimizationStrategy" value="balanced">
                    Balanced
                </label>
                <!-- Course boxes -->
                <div id="course-boxes" style="display: flex; flex-wrap: wrap; justify-content: center;"></div>
                <input type="submit" id="submitStableCourses" value="OK">
            </div>
        </div>

        <div id="validationModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeValidationModal()">&times;</span>
                <h2>Validation Information</h2>
                <div id="validationInfoContent">
                    <!-- Validation information will be displayed here -->
                </div>
            </div>
        </div>

        <div id="plan-heading">
            <h2>Your Four Year Plan</h2>
            <!-- Alert and success icons will be appended here -->
        </div>

        <!-- Content for Four Year Plan section -->
        <div id="plan" style="display: flex; flex-wrap: wrap; justify-content: center;"></div>

        <button id="validateBtn">Validate</button>
        <button id="optimizeBtn">Optimize</button>
        <button id="keepOldBtn" style="display: none;">Keep Old Plan</button>
        <button id="saveBtn" style="display: none;">Save</button>
        <button id="viewValidateInfo" style="display: none;">View Validation Info</button>
        <button id="clearValidationInfo" style="display: none;">Clear</button>

    </section>

    <footer>
        <p>&copy; 2024 MAPS - My Academic Planning System. All rights reserved.</p>
    </footer>

    <script>
        var fourYearPlan;
        var validationData;
        var stableCourses = [];
        var optimizedPlan = [];
        var optimizedClicked = false;

        function showSpinner() {
            document.getElementById('spinner').style.display = 'block';
            document.getElementById('plan-section').style.display = 'none';
        }

        // Function to hide the spinner
        function hideSpinner() {
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('plan-section').style.display = 'block';

        }
        function sendRequest(method, url, data = undefined) {
            showSpinner();
            return new Promise(function (resolve, reject) {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4) {
                        if (this.status == 200) {
                            var response = this.responseText;
                            console.log(response);
                            resolve(response); // Resolve with the response
                            hideSpinner();
                        } else {
                            reject(new Error('Request failed')); // Reject with an error
                            hideSpinner();
                        }
                    }
                };

                xhttp.open(method, url, true);
                if (data != undefined) {
                    xhttp.setRequestHeader('Content-Type', 'application/json');
                }
                data == undefined ? xhttp.send() : xhttp.send(data);
            });
        }

        document.addEventListener('DOMContentLoaded', async function () {
            plan = await sendRequest("GET", "http://127.0.0.1:3000/4yrplan/ach127");
            fourYearPlan = JSON.parse(plan);
            displayFourYearPlan(fourYearPlan)
        });

        // Function to display the retrieved four year plan on the page
        function displayFourYearPlan(res) {
            plan = res;
            var schedule = {
                0: [], // Freshman Fall
                1: [], // Freshman Spring
                2: [], // Sophomore Fall
                3: [], // Sophomore Spring
                4: [], // Junior Fall
                5: [], // Junior Spring
                6: [], // Senior Fall
                7: []  // Senior Spring
            };
            plan.forEach(function (course) {
                schedule[course.semester].push(course.course);
            });

            // Display schedule in HTML
            var scheduleContainer = document.getElementById('plan');
            scheduleContainer.innerHTML = '';

            for (var semester = 0; semester <= 7; semester++) {
                var semesterBox = document.createElement('div');
                semesterBox.classList.add('semester-box');

                var semesterTitle = document.createElement('div');
                semesterTitle.classList.add('semester-title');
                semesterTitle.textContent = getSemesterName(semester);
                semesterBox.appendChild(semesterTitle);

                var coursesList = document.createElement('ul');
                coursesList.classList.add('courses-list');
                schedule[semester].forEach(function (course) {
                    var courseItem = document.createElement('li');
                    courseItem.textContent = course;
                    coursesList.appendChild(courseItem);
                });
                semesterBox.appendChild(coursesList);

                scheduleContainer.appendChild(semesterBox);
            }
        }

        function getSemesterName(semester) {
            switch (semester) {
                case 0: return 'Freshman Fall';
                case 1: return 'Freshman Spring';
                case 2: return 'Sophomore Fall';
                case 3: return 'Sophomore Spring';
                case 4: return 'Junior Fall';
                case 5: return 'Junior Spring';
                case 6: return 'Senior Fall';
                case 7: return 'Senior Spring';
                default: return 'Unknown';
            }
        }

        // Function to send request to validate the four year plan
        async function validate() {
            var userInput = prompt("Enter a concentration ID for validation:");
            validationData = JSON.parse(await sendRequest("GET", "http://127.0.0.1:3000/4yrplan/ach127/validate?concentrationID=" + userInput));
            validationResponse(validationData);
        }

        function validationResponse(res) {
            var responseData = res;

            // Check if any prerequisite errors or corequisite errors exist
            var hasPrereqErrors = Object.keys(responseData.validatePreCoReqs.prereqErrors).length > 0;
            var hasCoreqErrors = Object.keys(responseData.validatePreCoReqs.coreqErrors).length > 0;

            // Check if concentration courses are fulfilled
            var isConcentrationFulfilled = responseData.validateConcentrationCourses.isFulfilledConcentationCourses;

            // Check if residency requirements are met
            var isValidResidency = responseData.validateResidency.isValidResReq;

            // Get unassigned courses and number of missing residency requirements
            var unassignedCourses = responseData.validateConcentrationCourses.unassignedCourses;
            var numMissingResReq = responseData.validateResidency.numMissing;

            // Highlight unused course IDs in red with tooltip
            var unusedCourseIDs = responseData.validateConcentrationCourses.unusedIds;
            unusedCourseIDs.forEach(function (courseID) {
                var courseElements = document.querySelectorAll('.courses-list li');
                courseElements.forEach(function (element) {
                    if (element.textContent === courseID) {
                        element.classList.add('unused-course');
                        element.title = 'Course not being used';
                    }
                });
            });

            // Highlight fulfilled concentration courses in green with tooltip
            var refinedMap = responseData.validateConcentrationCourses.refinedMap;
            for (var key in refinedMap) {
                if (refinedMap.hasOwnProperty(key)) {
                    var fulfilledCourseID = refinedMap[key].course;
                    var semester = refinedMap[key].semester;
                    var courseElements = document.querySelectorAll('.courses-list li');
                    courseElements.forEach(function (element) {
                        if (element.textContent === fulfilledCourseID) {
                            element.classList.add('fulfilled-course');
                            element.title = 'Fulfills requirement: ' + key;
                        }
                    });
                }
            }
            showValidateInfoButtons();
        }


        function showModal() {
            document.getElementById('myModal').style.display = 'block';
        }

        // Function to close the modal
        function closeModal() {
            document.getElementById('myModal').style.display = 'none';
        }

        async function optimize() {
            stableCourses = [];
            var { courses, strategy } = await getOptimizeSettings();
            var coursesWithStableSemesters = JSON.parse(JSON.stringify(fourYearPlan));

            coursesWithStableSemesters.forEach(function (course) {
                if (!courses.includes(course.course)) {
                    course.semester = -1;
                }
            });
            optimizedPlan = JSON.parse(await sendRequest("POST", "http://127.0.0.1:3000/4yrplan/ach127/optimize?method=" + strategy, JSON.stringify({ "futureCourses": coursesWithStableSemesters })));

            modifiedPlan = [];
            for (var key in optimizedPlan) {
                if (optimizedPlan.hasOwnProperty(key)) {
                    modifiedPlan.push({ course: optimizedPlan[key].courseID, semester: optimizedPlan[key].semester });
                }
            }

            displayFourYearPlan(modifiedPlan);
            handleButtonDisplay(); // Handle button display after optimization
        }

        async function getOptimizeSettings() {
            showModal(); // Show the modal

            optimizedClicked = true;

            // Retrieve the course boxes and populate them
            var courseBoxesContainer = document.getElementById('course-boxes');
            courseBoxesContainer.innerHTML = ''; // Clear existing content

            // Iterate over the four-year plan and create course boxes
            for (var semester = 0; semester <= 7; semester++) {
                var semesterBox = document.createElement('div');
                semesterBox.classList.add('semester-box');

                var semesterTitle = document.createElement('div');
                semesterTitle.classList.add('semester-title');
                semesterTitle.textContent = getSemesterName(semester); // Get semester name
                semesterBox.appendChild(semesterTitle);

                // Create a list for courses in the semester
                var coursesList = document.createElement('ul');
                coursesList.classList.add('courses-list');
                fourYearPlan.forEach(function (course) {
                    if (course.semester === semester) {
                        var courseItem = document.createElement('li');
                        courseItem.textContent = course.course;
                        // Add click event to select the course
                        courseItem.addEventListener('click', function () {
                            handleCourseClick(courseItem);
                        });
                        coursesList.appendChild(courseItem);
                    }
                });
                semesterBox.appendChild(coursesList);

                courseBoxesContainer.appendChild(semesterBox);
            }

            // Return a promise to handle the "OK" button click
            return new Promise(function (resolve, reject) {
                document.getElementById('submitStableCourses').addEventListener('click', function () {
                    // Resolve with the stable courses array
                    var strategy = document.querySelector('input[name="optimizationStrategy"]:checked').value;

                    resolve({ courses: stableCourses, strategy: strategy });
                    closeModal(); // Close the modal
                });
            });
        }

        function handleCourseClick(courseItem) {
            var courseName = courseItem.textContent.trim();
            var semesterName = courseItem.closest('.semester-box').querySelector('.semester-title').textContent.trim();
            var index = stableCourses.findIndex(function (c) {
                return c.course === courseName;
            });
            if (index === -1) {
                // Add the course to the stable courses array
                stableCourses.push(courseName);
                // Highlight the selected course in red
                courseItem.classList.add('selected-course');
            } else {
                // Remove the course from the stable courses array
                stableCourses.splice(index, 1);
                // Remove the red highlight from the course
                courseItem.classList.remove('selected-course');
            }
        }

        async function saveSchedule() {
            var response = await sendRequest("PUT", "http://127.0.0.1:3000/4yrplan/ach127/save", JSON.stringify(optimizedPlan));

            console.log(response); // Log the server response
            // Hide the Save and Keep Old buttons
            document.getElementById('saveBtn').style.display = 'none';
            document.getElementById('keepOldBtn').style.display = 'none';
            // Show the Validate and Optimize buttons
            document.getElementById('validateBtn').style.display = 'inline-block';
            document.getElementById('optimizeBtn').style.display = 'inline-block';
        }


        function handleButtonDisplay() {
            // Hide the Validate and Optimize buttons
            document.getElementById('validateBtn').style.display = 'none';
            document.getElementById('optimizeBtn').style.display = 'none';

            document.getElementById('keepOldBtn').style.display = 'inline-block';
            document.getElementById('saveBtn').style.display = 'inline-block';
        }

        // Function to handle the revert to original schedule
        function keepOldSchedule() {
            displayFourYearPlan(fourYearPlan); // Revert to original schedule
            // Hide the Save and Keep Old buttons
            document.getElementById('keepOldBtn').style.display = 'none';
            document.getElementById('saveBtn').style.display = 'none';

            // Show the Validate and Optimize buttons
            document.getElementById('validateBtn').style.display = 'inline-block';
            document.getElementById('optimizeBtn').style.display = 'inline-block';
        }

        function showValidateInfoButtons() {
            // Hide the Validate and Optimize buttons
            document.getElementById('validateBtn').style.display = 'none';
            document.getElementById('optimizeBtn').style.display = 'none';

            document.getElementById('viewValidateInfo').style.display = 'inline-block';
            document.getElementById('clearValidationInfo').style.display = 'inline-block';
        }

        function showValidationInfo() {
            var validationInfoContent = document.getElementById('validationInfoContent');
            // Clear previous content
            validationInfoContent.innerHTML = '';

            // Add overall validation status
            var overallStatus = document.createElement('h3');
            overallStatus.textContent = 'Overall Validation Status:';
            validationInfoContent.appendChild(overallStatus);

            var overallStatusText = document.createElement('p');
            overallStatusText.textContent = validationData.validatePreCoReqs.isValidOrder &&
                validationData.validateConcentrationCourses.isFulfilledConcentationCourses &&
                validationData.validateResidency.isValidResReq ? 'Validated' : 'Invalid';
            overallStatusText.style.color = validationData.validatePreCoReqs.isValidOrder &&
                validationData.validateConcentrationCourses.isFulfilledConcentationCourses &&
                validationData.validateResidency.isValidResReq ? 'green' : '#CC0033';
            validationInfoContent.appendChild(overallStatusText);

            // Add section for prerequisites and corequisites
            var prereqCoreqStatus = document.createElement('h3');
            prereqCoreqStatus.textContent = 'Prerequisites and Corequisites:';
            validationInfoContent.appendChild(prereqCoreqStatus);

            // Add status for prerequisites and corequisites
            var prereqCoreqStatusText = document.createElement('p');
            prereqCoreqStatusText.textContent = validationData.validatePreCoReqs.isValidOrder ? 'Validated' : 'Invalid';
            prereqCoreqStatusText.style.color = validationData.validatePreCoReqs.isValidOrder ? 'green' : '#CC0033';
            validationInfoContent.appendChild(prereqCoreqStatusText);

            // Add section for concentration requirements
            var concentrationStatus = document.createElement('h3');
            concentrationStatus.textContent = 'Concentration Requirements:';
            validationInfoContent.appendChild(concentrationStatus);

            // Add status for concentration requirements
            var concentrationStatusText = document.createElement('p');
            concentrationStatusText.textContent = validationData.validateConcentrationCourses.isFulfilledConcentationCourses ? 'Fulfilled' : 'Missing';
            concentrationStatusText.style.color = validationData.validateConcentrationCourses.isFulfilledConcentationCourses ? 'green' : '#CC0033';
            validationInfoContent.appendChild(concentrationStatusText);

            // Add section for residency requirements
            var residencyStatus = document.createElement('h3');
            residencyStatus.textContent = 'Residency Requirements:';
            validationInfoContent.appendChild(residencyStatus);

            // Add status for residency requirements
            var residencyStatusText = document.createElement('p');
            residencyStatusText.textContent = validationData.validateResidency.isValidResReq ? 'Met' : 'Not Met';
            residencyStatusText.style.color = validationData.validateResidency.isValidResReq ? 'green' : '#CC0033';
            validationInfoContent.appendChild(residencyStatusText);

            // Add missing prerequisites and corequisites, if any
            if (Object.keys(validationData.validatePreCoReqs.prereqErrors).length > 0 || Object.keys(validationData.validatePreCoReqs.coreqErrors).length > 0) {
                var prereqCoreqList = document.createElement('div');
                prereqCoreqList.innerHTML = '<h4>Missing Prerequisites and Corequisites:</h4>';
                var missingPrereqs = validationData.validatePreCoReqs.prereqErrors;
                for (var prereq in missingPrereqs) {
                    if (missingPrereqs.hasOwnProperty(prereq)) {
                        var prereqItem = document.createElement('p');
                        prereqItem.textContent = 'Prerequisite: ' + prereq + ', Missing: ' + missingPrereqs[prereq].join(', ');
                        prereqCoreqList.appendChild(prereqItem);
                    }
                }
                var missingCoreqs = validationData.validatePreCoReqs.coreqErrors;
                for (var coreq in missingCoreqs) {
                    if (missingCoreqs.hasOwnProperty(coreq)) {
                        var coreqItem = document.createElement('p');
                        coreqItem.textContent = 'Corequisite: ' + coreq + ', Missing: ' + missingCoreqs[coreq].join(', ');
                        prereqCoreqList.appendChild(coreqItem);
                    }
                }
                validationInfoContent.appendChild(prereqCoreqList);
            }

            // Add missing concentration requirements, if any
            if (validationData.validateConcentrationCourses.unassignedCourses.length > 0 || validationData.validateConcentrationCourses.unusedIds.length > 0) {
                var concentrationList = document.createElement('div');
                concentrationList.innerHTML = '<h4>Missing Concentration Requirements:</h4>';
                if (validationData.validateConcentrationCourses.unassignedCourses.length > 0) {
                    var unassignedCourses = document.createElement('p');
                    unassignedCourses.textContent = 'Missing Requirement Courses: ' + validationData.validateConcentrationCourses.unassignedCourses.join(', ');
                    concentrationList.appendChild(unassignedCourses);
                }
                if (validationData.validateConcentrationCourses.unusedIds.length > 0) {
                    var unusedIds = document.createElement('p');
                    unusedIds.textContent = 'Unused IDs: ' + validationData.validateConcentrationCourses.unusedIds.join(', ');
                    concentrationList.appendChild(unusedIds);
                }
                validationInfoContent.appendChild(concentrationList);
            }

            // Add missing residency requirements, if any
            if (!validationData.validateResidency.isValidResReq) {
                var residencyList = document.createElement('div');
                residencyList.innerHTML = '<h4>Missing Residency Requirements:</h4>';
                var numMissing = document.createElement('p');
                numMissing.textContent = 'Number of Missing Requirements: ' + validationData.validateResidency.numMissing;
                residencyList.appendChild(numMissing);
                validationInfoContent.appendChild(residencyList);
            }

            // Open the modal
            document.getElementById('validationModal').style.display = 'block';
        }

        // Function to close the modal
        function closeValidationModal() {
            document.getElementById('validationModal').style.display = 'none';
        }

        // Function to clear validation and revert to original plan
        function clearValidation() {
            displayFourYearPlan(fourYearPlan);
            document.getElementById('viewValidateInfo').style.display = 'none';
            document.getElementById('clearValidationInfo').style.display = 'none';

            // Show the "Validate" and "Optimize" buttons
            document.getElementById('validateBtn').style.display = 'inline-block';
            document.getElementById('optimizeBtn').style.display = 'inline-block';
        }


        document.getElementById('optimizeBtn').addEventListener('click', optimize);
        document.getElementById('validateBtn').addEventListener('click', validate);
        document.getElementById('saveBtn').addEventListener('click', saveSchedule);
        document.getElementById('keepOldBtn').addEventListener('click', keepOldSchedule);
        document.getElementById('viewValidateInfo').addEventListener('click', showValidationInfo);
        document.getElementById('clearValidationInfo').addEventListener('click', clearValidation);
    </script>

</body>

</html>
